#' @title
#' Generate a synthetic data from a stub precursor object
#' 
#' @description
#' `ble()` is an internal function of [`stubble`] that is used to generate 
#' synthetic data from an precursor object that has been generated by [stub].
#' 
#' @param stub the stub object which synthetic data is generated.
#' @param rows the number of elements to generate.
#' @param ctrl a named list of control parameters for generating the synthetic
#' data. See [ctrl].
#' @param ... named individual control parameters, which take precedence over
#' those in the `ctrl` list.
#'
#' @details
#' `ble()` calls an internal S3 generic function, `ble_()`, with built-in
#' methods for the `list` and `data.frame` base R data types, in addition to
#' `data.table` and `tbl_df` data types, where the required _data.table_ and
#' _tibble_ packages are installed.
#' 
#' @return
#' An object of the same class used in [`stub`].
#' 
#' @seealso 
#' [stubble_control]
#' 
#' @examples
#' ble(stub(iris))
#' ble(stub(iris), rows = 10)
#' 
#' @concept empirical
#' @concept ecdf
#' @concept resample
#' @concept simulate
#' @concept simulated
#' @concept simulation
#' 
#' @keywords datagen


### ToDo ###
# - Pass all ble_() methods through ble_.list() to avoid code replication.


### ble() ###
#' @export
ble <- function(stub, rows, ctrl = list(), ...){
  
  ### Data Extraction ###
  dtype <- stub[["dtype"]]
  vars <- stub[["vars"]]
  old_ctrl <- stub[["ctrl"]]
  
  ## Control Params ## - Got to be a one-liner for this!
  ctrl <- c(
    ctrl[!{names(ctrl) %in% names(old_ctrl)}],
    ctrl[names(ctrl) %in% names(old_ctrl)],
    old_ctrl[!{names(old_ctrl) %in% names(ctrl)}]
  )
  
  ## Create Index ##
  index <- seq_along(vars)
  
  ### Rows ###
  if (missing(rows)) rows <- sapply(vars, `[[`, "n")
  
  ## Apply ble_attr() ##
  l <- mapply(
    FUN = ble_attr,
    x = vars,
    elements = rows,
    index = index,
    MoreArgs = list(ctrl = ctrl, ...),
    SIMPLIFY = FALSE,
    USE.NAMES = TRUE
  )
  
  ## Coerce to Correct Output Type ##
  out <- ble_(dtype = dtype, l = l)
  
  ## Output ##
  return(out)
  
}


### ble_() ###
#' @noRd
ble_ <- function(dtype, ...){
  
  ## Define S3 Method ##
  UseMethod("ble_", dtype)
  
}


### ble_.default() ###
#' @noRd
ble_.default <- function(dtype, l){
  
  ## Error ##
  .stop_no_method(dtype)
  
}


### ble_.data.frame() ###
#' @noRd
ble_.data.frame <- function(dtype, l){
  
  ## Coerce to data.frame ##
  out <- as.data.frame(l)
  
  ## Output ##
  return(out)
  
}


### ble_.data.table() ###
#' @noRd
ble_.data.table <- function(dtype, l){
  
  ## Coerce to data.table ##
  out <- if (is.installed.package("data.table")){
    
    data.table::as.data.table(l)
    
  } else {
    
    # Warning #
    .warning_coercion(dtype)
    
    as.data.frame(l)
    
  }
  
  ## Output ##
  return(out)
  
}


### ble_.list() ###
#' @noRd
ble_.list <- function(dtype, l){
  
  ## Output ##
  return(l)
  
}


### ble_.tbl_df() ###
#' @noRd
ble_.tbl_df <- function(dtype, l){
  
  ## Coerce to tbl_df ##
  out <- if (is.installed.package("tibble")){
    
    tibble::as_tibble(l)
    
  } else {
    
    # Warning #
    .warning_coercion(dtype)
    
    as.data.frame(l)
    
  }
  
  ## Output ##
  return(out)
  
}
